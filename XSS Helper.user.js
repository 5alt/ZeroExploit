// ==UserScript==
// @name         XSS Helper
// @version      0.1
// @description  XSS Helper
// @exclude      http://*.google.com/*
// @exclude      https://*.google.com/*
// @match        http://vulnweb.com/*
// @match        https://vulnweb.com/*
// @grant        none
// @run-at document-start
// ==/UserScript==


// @match        http://*/*
// @match        https://*/*

//md5_salt
__XSSHelper_reporturl = "http://127.0.0.1:5000/report_log";
function __XSSHelper_ReportDetection(method, info){
    var url = __XSSHelper_reporturl+"?url="+escape(window.location.href)+"&method="+escape(method)+"&info="+escape(info);
    new Image().src=url;
}

// auto fill forms
(function() {
    document.all.constructor.prototype.forEach = Array.prototype.forEach;
    document.all.forEach(function(n){
        fuzz_mark_color = '#cfffdd';
        //fuzz_value = 'md5_salt23333\'"\\';
        //fuzz_textarea = 'md5_salt23333\'"\\<img src=1 onerror=alert(1)><svg/onload=alert(1)//';
        fuzz_value = '\'"onerror=prompt(233)//{{97766553-1}}${97766554-2}<svg/onload=prompt(233)//\\';
        fuzz_textarea = fuzz_value;
        if((n.tagName.toLowerCase() == 'input' && n.type.toLowerCase() == 'text') && n.type.toLowerCase() !== 'hidden' && !n.readOnly){
            n.style.backgroundColor = fuzz_mark_color;
            n.value = fuzz_value;
        }
        if(n.tagName.toLowerCase() == 'textarea' && n.type.toLowerCase() !== 'hidden'){
            n.style.backgroundColor = fuzz_mark_color;
            n.value = fuzz_textarea;
        }
    });
})();

// hook window.onerror
(function() {
    __XSSHelper_onerror = window.onerror;
    window.onerror = function (msg, url, lineNo, columnNo, error) {
        if(__XSSHelper_onerror) __XSSHelper_onerror();
        var string = msg.toLowerCase();
        var substring = "script error";
        if (string.indexOf(substring) > -1){
            //alert('Script Error: See Browser Console for Detail');
            __XSSHelper_ReportDetection('window.onerror', 'js error see console');
        } else {
            var message = [
                'Message: ' + msg,
                'URL: ' + url,
                'Line: ' + lineNo,
                'Column: ' + columnNo,
                'Error object: ' + JSON.stringify(error)
            ].join(' - ');
            if(msg.indexOf('SyntaxError') != -1 || msg.indexOf('Uncaught ReferenceError') != -1){
                console.log(message);
                __XSSHelper_ReportDetection('window.onerror', 'js error');
            }
        }

        return false;
    };

})();

function __XSSHelper_GetQueryParams() {
    var url = location.search; //获取url中"?"符后的字串
    var theRequest = new Object();
    if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for(var i = 0; i < strs.length; i ++) {
            theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
        }
    }
    return theRequest;
}

// find flash
(function() {
    setTimeout(function(){
        var urls = performance.getEntries();
        have_flash = false;
        urls.forEach(function(e){
            if(e.name.indexOf(".swf") !== -1){
                have_flash = true;
                console.warn("%c"+location.hostname+' 发现Flash:'+e.name,"color:red;font-size:13px");
            }
        });
        if(have_flash) __XSSHelper_ReportDetection('flash', 'Flash found!');
    }, 5000);
    /*
    for(var i=0,tags=document.querySelectorAll('iframe[src],frame[src],script[src],link[rel=stylesheet],object[data],embed[src]'),tag;tag=tags[i];i++){
        var a = document.createElement('a');
        a.href = tag.src||tag.href||tag.data;
        if(a.href.indexOf(".swf") !== -1){console.warn("%c"+location.hostname+' 发现Flash['+tag.localName+']:'+a.href,"color:red;font-size:13px");}
        if(a.hostname!=location.hostname){
            //console.warn("%c"+location.hostname+' 发现第三方资源['+tag.localName+']:'+a.href,"color:red;font-size:13px");
        }
    }
    */
})();

//hook innerHTML
(function () {
    var setter = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').set;
    Object.defineProperty(Element.prototype, 'innerHTML', {
        set: function innerHTML_Setter(val) {
            /*
                console.group();
                console.log('innerHTML on Object:', this);
                console.log('Value:', JSON.stringify(val));
                var stack = new Error().stack;
                // Remove this function from the stack:
                stack = stack.trim().split('\n').slice(1).join(' <- ')
                console.log('Stack: ', stack)
                console.groupEnd(); */
            params = __XSSHelper_GetQueryParams();
            if(window.location.hash.substr(1)) params["__local_hash"] = window.location.hash.substr(1);
            for (var key in params){
                if(val.indexOf(params[key]) !== -1 && isNaN(params[key])){
                    console.group();
                    //console.log(document.currentScript.src);
                    console.log('innerHTML on Object:', this);
                    console.log('Key:', JSON.stringify(key));
                    console.log('Value:', JSON.stringify(val));
                    var stack = new Error().stack;
                    // Remove this function from the stack:
                    stack = stack.trim().split('\n').slice(1).join(' <- ');
                    console.log('Stack: ', stack);
                    console.groupEnd();
                    //alert("query appears in innerHTML");
                    __XSSHelper_ReportDetection('innerHTML', 'query appears in innerHTML');
                }
            }
            // call original innerHTML setter:
            return setter.call(this, val);
        }
    });
})();

//hook window.postMessage
(function () {
    window.__postMessage__ = window.postMessage;
    window.postMessage = function(){
        if(arguments[1] == "*"){
            //alert("Post Message origin is *!");
            console.log(arguments[0]);
            console.log(document.currentScript.src);
            __XSSHelper_ReportDetection('window.postMessage', 'Post Message origin is *!');
        }
        window.__postMessage__.apply(this, arguments);
    };
})();

//hook window.prompt
(function () {
    window.__prompt__ = window.prompt;
    window.prompt = function(){
        if(arguments[0] == 233){
            __XSSHelper_ReportDetection('window.prompt', 'xss found');
        }
        window.__prompt__.apply(this, arguments);
    };
})();